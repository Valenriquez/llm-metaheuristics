import ollama 
import os
import json

from dataclasses import dataclass
from chromadb.api.models.Collection import Collection

@dataclass
class Exploitation:
    problem_id: int
    dimensions: int
    model: str = "qwen2.5-coder:latest"
    model_embed: str = "all-minilm:latest"
    optuna_collection:  Collection = None 


    def exploitation(self, number_iteration):
        print("Beginning with exploitation number --->",  number_iteration)

        # Query TO SEE OPTUNA - - - - - - - - - - - - - - - - - - -
        output_operators = ollama.embeddings(
        prompt=f"Remember to write the operators' names",
        model=self.model_embed
        )
        results = self.optuna_collection.query(
        query_embeddings=[output_operators["embedding"]],
        n_results=1
        )
        data  = results['documents'][0][0]
        print("operators data:  ", data)
        
        # Query TO SEE OPTUNA - - - - - - - - - - - - - - - - - - -
     
        output_feedback = ollama.embeddings(
        prompt="Give me the best operators for the given metaheuristic",
        model=self.model_embed
        )
        results = self.optuna_collection.query(
        query_embeddings=[output_feedback["embedding"]],
        n_results=3
        )
        answer = results['documents'][0][0]
        print("The best operators for the given problem---", answer)
        # Query for the Feedback - - - - - - - - - - - - - - - - - - -
        output = ollama.generate(
                model=self.model,
                prompt = f"""
                ### INSTRUCTIONS FOR METAHEURISTIC REFINEMENT:
                1. Analyze the provided metaheuristic data and performance constraints to create a refined metaheuristic.
                2. Focus on strategies that either **improve performance**, **reduce computational cost**, or achieve a balance between the two.
                3. Suggest specific modifications to:
                    - Operators
                    - Parameters
                    - Selectors
                Base your suggestions strictly on the given data without inventing new operators. Variations or combinations of existing operators are acceptable.
                4. Output the response in **code format only**, avoiding any explanations, markdown, or triple backticks (` ``` `).
                5. Ensure the metaheuristic design reflects logical, diverse, and effective strategies without exceeding computational constraints.

                ### CONTEXT:
                - **Current Iteration**: {number_iteration}
                - **Best Metaheuristic So Far**: {answer}

                ### OBJECTIVE:
                Generate a code-based response that integrates the feedback and refines the metaheuristic to improve the performance.
                """
            )
        answer = output['response']

        return answer

            
